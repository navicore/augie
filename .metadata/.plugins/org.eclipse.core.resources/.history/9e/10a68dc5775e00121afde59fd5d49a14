package com.onextent.augmatic;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import android.app.Dialog;
import android.view.LayoutInflater;
import android.view.View;

import android.os.Bundle;
import android.support.v4.app.DialogFragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentTransaction;
import android.util.Log;
import android.view.ViewGroup;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.TextView;

import com.actionbarsherlock.app.SherlockDialogFragment;
import com.actionbarsherlock.app.SherlockFragmentActivity;
import com.onextent.augie.AugieActivity;
import com.onextent.augie.AugieException;
import com.onextent.augie.Augiement;
import com.onextent.augie.AugiementFactory;
import com.onextent.augie.Mode;
import com.onextent.augie.ModeManager;
import com.onextent.android.codeable.Codeable;
import com.onextent.android.codeable.CodeableName;

public class AugiementStatusDialog extends SherlockDialogFragment {

            @Override
            public View onCreateView(LayoutInflater inflater,
                    ViewGroup container, Bundle savedInstanceState) {

                Dialog d = getDialog();
                if (d != null) d.setTitle("Enable Augiement");
                View v = inflater.inflate(R.layout.module_status, container, false);
                CheckBox cbox = (CheckBox) v.findViewById(R.id.module_enabled);

                final CodeableName cn = cnList.get(position);

                boolean isEnabled = modeAugiements.containsKey(cn);
                cbox.setChecked(isEnabled);
                updateButtonText(cbox, cn, isEnabled);
                updateStatusText(v, cn);

                cbox.setOnCheckedChangeListener(new OnCheckedChangeListener() {

                    @Override
                    public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {

                        ModeManager modeManager = ((AugieActivity) getActivity()).getModeManager();
                        AugiementFactory af = modeManager.getAugiementFactory();
                        Mode mode = modeManager.getCurrentMode();
                        if (isChecked) {
                            Augiement a = af.newInstance(cn);
                            mode.addAugiement(a);
                            updateButtonText(buttonView, cn, isChecked);
                        } else {
                            Augiement a = modeAugiements.get(cn);
                            mode.removeAugiement(a);
                        }
                        try {
                            modeManager.setCurrentMode(mode);
                        } catch (AugieException e) {
                            Log.e(Codeable.TAG, e.toString(), e);
                        } //reset everything with new a
                    }
                });

                return v;
            }

    private void updateStatusText(View v, CodeableName cn) {

        TextView desc = (TextView) v.findViewById(R.id.module_description);
        TextView deps = (TextView) v.findViewById(R.id.module_dependencies);
        Augiement.Meta m = allAugiements.get(cn);
        desc.setText(m.getDescription());
    }
    
    private void updateButtonText(CompoundButton b, CodeableName cn, boolean isEnabled) {
            
        String n = allAugiements.get(cn).getUIName();
        if (isEnabled) {
            b.setText(n + " is enabled");
        } else {
            b.setText(n + " is disabled");
        }
    }
}
